{% extends "base.html" %}
{% block body %}

<div id="graph-container">
<!-- <script type="text/javascript" src= "{{ url_for('static', filename='js/forcegraph.js') }}"></script> -->
</div>
  <div class="row">
      <div class="col-sm-8 blog-main">
         {% for entry in entries %}
            <div class="blog-post">
              <h2 class="blog-post-title"><a href="{{ url_for('post', id=entry.id) }}">{{ entry.title }}</a></h2><hr>
              <p class="blog-post-meta"><a href="{{ url_for('post', id=entry.id) }}">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</a></p>
              <p>{{ entry.text|safe }}</p>
            </div>
          {% else %}
              <div>No entries here so far</div>
          {% endfor %}
        </div>

  </div>


<script>
  function findHashtags(searchText){
    var regexp = /\B\#\w\w+\b/g
    var result = searchText.match(regexp);
    result_list = [];
    if (result) {
      var num_of_hashtags = result.length;
      for(var i=0;i<num_of_hashtags;i++) {
        var word_length = result[i].length;
        result_list.push(result[i].substring(1, word_length));
      }
      return result_list
    }
    else {
      return false;
    }
  }
  var links = [];
  {% for entry in entries %}
    var hash_list = findHashtags( {{ entry.text|tojson|safe }} );
    var default_uri = window.location.href;
    var source_uri = default_uri + "post/"+{{entry.id}};
    if (hash_list) {
      var num_of_hashtags = hash_list.length;
      for(var i=0;i<num_of_hashtags;i++) {
        links.push({
          source: "{{entry.title}}",
          target: hash_list[i]
        });
      }
    }
    else {
      links.push({
        source: "{{entry.title}}",
        target: "{{entry.title}}"
      });
    }
  {% endfor %}

  var nodes={};
  links.forEach(function(link) {
    link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
    link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
  });

  for (var node in nodes) {
    {% for entry in entries %}
    var cur_uri = window.location.href + "post/" + {{entry.id}};
    if (node == "{{entry.title}}"){
      nodes[node].uri = cur_uri;
    }
    {% endfor %}
  }

  var width = document.getElementById('graph-container').offsetWidth;
  var height = width*3/4;
  var color = d3.scale.category20();
  var force = d3.layout.force()
    .nodes(d3.values(nodes))
    .links(links)
    .size([width, height])
    .linkDistance(60)
    .charge(-300)
    .on("tick", tick)
    .start();
  var svg = d3.select("#graph-container").append("svg")
    .attr("viewBox", "0 0 "+width+" "+height)
    .append("g");
  var link = svg.selectAll(".link")
    .data(force.links())
    .enter().append("line")
    .attr("class", "link");
  var node = svg.selectAll(".node")
    .data(force.nodes())
    .enter().append("g")
    .attr("class", "node")
    .attr("link", function(d) { return d.uri; })
    .on("mouseover", mouseover)
    .on("mouseout", mouseout)
    .on("click", click)
    .call(force.drag);
  node.append("circle")
    .style("fill", function(d) { return color(d.group); })
    .attr("selected", 0)
    .attr("r", 10);
    // .attr("r", function(d) { return d.value; });
  node.append("text")
    .attr("x", 12)
    .attr("dy", ".35em")
    .text(function(d) { return d.name; })
    .style("visibility", "hidden");
  function tick() {
    link
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
    node
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    }
  function mouseover() {
    d3.selectAll("circle").style("opacity", 0.5);
    d3.select(this).select("circle").style("opacity", 1);
    d3.select(this).select("text").style("visibility", "visible");
    }
  function mouseout() {
    d3.selectAll("circle").style("opacity", 1);
    d3.select(this).select("text").style("visibility", "hidden");
    }
  function click(){
    var cur_state = d3.select(this).select("circle").attr("selected");
    if(cur_state==1){
      d3.select(this).select("circle").attr("selected", 0);
      window.location.href = this.getAttribute("link");
    }
    else{
      d3.selectAll("circle").style("stroke", "white");
      d3.selectAll("circle").attr("cursor", "default");
      d3.selectAll("circle").attr("selected", 0);
      d3.select(this).select("circle").style("stroke", "black");
      d3.select(this).select("circle").attr("selected", 1);
      d3.select(this).select("circle").attr("cursor", "pointer");
    }
  }
  function redraw(){
    vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
  }




</script>



{% endblock %}
